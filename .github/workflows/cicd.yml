name: CI/CD Pipeline

on:
    push:
        branches: ['master']
    pull_request:
        branches: ['master']

jobs:
    build-and-push:
        if: false # Set to true to enable the build and push job
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_PASSWORD }}
            - name: Build and push
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  KEY_AUTH_FILTER: ${{ secrets.KEY_AUTH_FILTER }}
                  KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
                  KAFKA_GROUP_ID: ${{ secrets.KAFKA_GROUP_ID }}
              run: |
                  docker compose -f docker-compose.yml build discover-server
                  docker compose -f docker-compose.yml push discover-server
    deploy:
        if: false # Set to true to enable the deploy job
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Execute remote SSH commands using SSH key
              uses: appleboy/ssh-action@v1
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  KEY_AUTH_FILTER: ${{ secrets.KEY_AUTH_FILTER }}
                  KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
                  KAFKA_GROUP_ID: ${{ secrets.KAFKA_GROUP_ID }}
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  envs: DOCKERHUB_USERNAME,KEY_AUTH_FILTER,KEYCLOAK_CLIENT_SECRET,KAFKA_GROUP_ID
                  script_path: _scripts/deploy.sh
